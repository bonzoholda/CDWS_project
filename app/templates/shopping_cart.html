<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shopping Cart Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>

    <!-- ✅ NAVBAR goes here -->
    <header>
      <nav>
          <ul>
              <li><a href="/admin">🏠 Dashboard</a></li>
              <li><a href="/admin/logout">🚪 Logout</a></li>
          </ul>
      </nav>
    </header>
    
<div class="form-container">


<!-- 🛒 CART SECTION (always visible, shows selected/paid bills with receipt link) -->
<section>
  <h3>🛒 Tagihan Dalam Keranjang</h3>
  <form action="/admin/update_payment_through_cart" method="post" id="cartForm">
    <table id="cartTable" class="invoice-table">
      <thead>
        <tr>
          <th>Pilih</th>
          <th>Nama</th>
          <th>Periode</th>
          <th>Tagihan</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody id="cartBody">
        {% set has_unpaid = false %}
        {% for bill in bills %}
          {% if bill.id in receipt_ids %}
            <tr data-bill-id="{{ bill.id }}">
              <td>
                {% if not bill.paid %}
                  {% set has_unpaid = true %}
                  <input type="checkbox" name="bill_ids" value="{{ bill.id }}">
                {% else %}
                  ✅
                {% endif %}
              </td>
              <td>{{ bill.user_name }}</td>
              <td>{{ bill.pay_period }}</td>
              <td style="text-align: right;">{{ "{:,.0f}".format(bill.bill_amount|float) }}</td>
              <td>
                {% if bill.paid %}
                  ✅ PAID<br>
                  <a href="/admin/receipt/{{ bill.id }}" target="_blank">🧾 Print Receipt</a>
                {% else %}
                  UNPAID
                {% endif %}
              </td>
            </tr>
          {% endif %}
        {% endfor %}
      </tbody>
    </table>

    {% if has_unpaid %}
      <button type="submit" style="margin-top: 1em;">✅ Checkout & Mark Selected as Paid</button>
    {% endif %}
  </form>
</section>





<!-- 🔍 AVAILABLE BILLS SECTION -->
<section style="margin-top: 3em;">
  <h3>📋 Daftar Tagihan Tersedia</h3>
  <div class="search-container">
    <input type="text" id="billSearch" placeholder="Search...">
    <span id="clearSearch">&times;</span>
  </div>

  <table id="availableBillsTable" class="invoice-table">
    <thead>
      <tr>
        <th>🛒 Tambah</th>
        <th>Nama</th>
        <th>Periode</th>
        <th>Tagihan</th>
      </tr>
    </thead>
    <tbody>
        {% for bill in bills %}
          {% if not bill.paid and bill.id not in receipt_ids %}
            <tr data-bill-id="{{ bill.id }}">
              <td>
                <button type="button" class="add-to-cart"
                        data-id="{{ bill.id }}"
                        data-name="{{ bill.user_name }}"
                        data-period="{{ bill.pay_period }}"
                        data-amount="{{ bill.bill_amount }}">
                  ➕
                </button>
              </td>
              <td>{{ bill.user_name }}</td>
              <td>{{ bill.pay_period }}</td>
              <td style="text-align: right;">{{ "{:,.0f}".format(bill.bill_amount|float) }}</td>
            </tr>
          {% endif %}
        {% endfor %}

    </tbody>
  </table>
</section>


<script>
  const cartBody = document.getElementById('cartBody');
  const addButtons = document.querySelectorAll('.add-to-cart');

  addButtons.forEach(btn => {
    btn.addEventListener('click', () => {
      const billId = btn.dataset.id;
      const userName = btn.dataset.name;
      const period = btn.dataset.period;
      const amount = parseFloat(btn.dataset.amount);

      // Check if already added
      if (document.querySelector(`#cartBody tr[data-bill-id='${billId}']`)) return;

      // Create new row in cart
      const row = document.createElement('tr');
      row.setAttribute('data-bill-id', billId);
      row.innerHTML = `
        <input type="hidden" name="bill_ids" value="${billId}">
        <td>${userName}</td>
        <td>${period}</td>
        <td style="text-align: right;">${amount.toLocaleString('id-ID')}</td>
        <td>UNPAID</td>
      `;
      cartBody.appendChild(row);
    });
  });

  // Search filter
  document.getElementById('billSearch').addEventListener('input', function () {
    const value = this.value.toLowerCase();
    document.querySelectorAll('#availableBillsTable tbody tr').forEach(row => {
      row.style.display = row.innerText.toLowerCase().includes(value) ? '' : 'none';
    });
  });

  document.getElementById('clearSearch').addEventListener('click', function () {
    document.getElementById('billSearch').value = '';
    document.querySelectorAll('#availableBillsTable tbody tr').forEach(row => row.style.display = '');
  });
</script>


</div>
</body>
</html>
